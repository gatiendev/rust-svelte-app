```markdown
# Full‑Stack Authentication System

A production‑ready authentication system built with **Rust** (Axum) for the backend API, **PostgreSQL** for data persistence, and **SvelteKit** for the frontend. The API uses JWT access tokens and database‑backed refresh tokens stored in HTTP‑only cookies. The entire stack is containerised with Docker Compose for easy development and deployment.

---

## Table of Contents

- [Technology Stack](#technology-stack)
- [Architecture Overview](#architecture-overview)
- [Project Structure](#project-structure)
- [Backend (Rust)](#backend-rust)
  - [Environment Variables](#backend-environment-variables)
  - [Key Features](#key-features)
  - [API Endpoints](#api-endpoints)
- [Frontend (SvelteKit)](#frontend-sveltekit)
  - [Environment Variables](#frontend-environment-variables)
  - [Authentication Flow](#frontend-authentication-flow)
- [Docker Compose Setup](#docker-compose-setup)
- [Running the Application](#running-the-application)
  - [Prerequisites](#prerequisites)
  - [Quick Start with Docker Compose](#quick-start-with-docker-compose)
  - [Running Locally (without Docker)](#running-locally-without-docker)
- [Development Tips](#development-tips)
- [Production Deployment](#production-deployment)
- [Security Considerations](#security-considerations)
- [Troubleshooting](#troubleshooting)
- [License](#license)

---

## Technology Stack

| Component       | Technology                                                                                      |
|-----------------|-------------------------------------------------------------------------------------------------|
| **Backend**     | Rust, Axum 0.7, SQLx, jsonwebtoken, argon2, tower-cookies, tracing                             |
| **Database**    | PostgreSQL 18 (with SQLx migrations)                                                            |
| **Frontend**    | SvelteKit, TypeScript, TailwindCSS, Vite                                                        |
| **Container**   | Docker, Docker Compose (with separate services for API, frontend, PostgreSQL)                  |
| **Authentication** | JWT access tokens + database‑backed refresh tokens (SHA‑256 hashed), HTTP‑only cookies       |

---

## Architecture Overview

```

┌─────────────────────────────────────────────────────────────┐
│                        Docker Network                        │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐  │
│  │   Frontend  │ ──► │   Backend   │ ──► │  PostgreSQL │  │
│  │ (SvelteKit) │      │  (Axum API) │      │             │  │
│  │   :5173     │ ◄── │   :8000     │ ◄── │   :5432     │  │
│  └─────────────┘      └─────────────┘      └─────────────┘  │
│         │                    │                    │         │
│         └──────── Cookies ────┘                    │         │
│               (HTTP‑only)                           │         │
│                                                      │         │
│            ┌────────────────────────────────────────┘         │
│            │                                                   │
│            ├─ users table                                      │
│            └─ refresh_tokens table                             │
└─────────────────────────────────────────────────────────────┘

```

- **Backend** serves a REST API, handles authentication, and issues JWT + refresh tokens as HTTP‑only cookies.
- **Frontend** consumes the API, storing cookies automatically (credentials: 'include'). It provides login/register forms, a profile page, and adapts navigation based on auth state.
- **PostgreSQL** stores user data (hashed passwords) and hashed refresh tokens.

---

## Project Structure

```

.
├── docker-compose.yml          # Orchestrates all services
├── rust_api/                   # Backend (Rust) – see its own README
│   ├── Cargo.toml
│   ├── Dockerfile.dev
│   ├── Dockerfile.prod
│   ├── migrations/
│   └── src/
└── frontend/                   # Frontend (SvelteKit) – see its own README
    ├── package.json
    ├── Dockerfile.dev
    ├── Dockerfile.prod
    ├── .env.example
    └── src/
        ├── lib/
        │   ├── components/
        │   ├── stores/
        │   └── types/
        └── routes/

```

---

## Backend (Rust)

### Backend Environment Variables

Create a `.env` file in `rust_api/` (or set in Docker):

```env
DATABASE_URL=postgres://auth_user:auth_pass@postgres:5432/auth_db
JWT_SECRET=your-64-byte-hex-secret-key-here-exactly-64-characters-long...
ACCESS_TOKEN_EXPIRATION=900          # seconds (15 minutes)
REFRESH_TOKEN_EXPIRATION=604800      # seconds (7 days)
HOST=0.0.0.0
PORT=8000
RUST_LOG=info
```

Generate a secure `JWT_SECRET`:

```bash
openssl rand -hex 32
```

### Key Features

- User registration with Argon2id password hashing.
- Login – issues access token (JWT) and refresh token (stored hashed with SHA‑256).
- Logout – invalidates the refresh token.
- Refresh endpoint – rotates refresh token and issues new access token.
- Protected profile endpoint.
- Cookies are `HttpOnly`, `Secure` (configurable), and have `Max-Age` matching token expiry.
- CORS configured for frontend origin (e.g., `http://localhost:5173`).
- Structured logging with `tracing` and request tracing via `tower-http`.

### API Endpoints

| Method | Endpoint   | Description                         | Request Body                          | Success Response          |
|--------|------------|-------------------------------------|---------------------------------------|---------------------------|
| POST   | `/register`| Create a new user                   | `{"username":"string","password":"string"}` | `201 Created`             |
| POST   | `/login`   | Authenticate and get tokens (cookies) | Same as above                         | `200 OK`                  |
| POST   | `/logout`  | Invalidate refresh token, clear cookies | –                                     | `200 OK`                  |
| POST   | `/refresh` | Get new access token using refresh token | –                                     | `200 OK`                  |
| GET    | `/profile` | Get current user info (requires access token) | –                                     | `200 OK` with user data   |

All error responses include a JSON `{ "message": "..." }`.

---

## Frontend (SvelteKit)

### Frontend Environment Variables

Create a `.env` file in `frontend/` (or set in Docker):

```env
VITE_API_URL=http://localhost:8000
```

### Frontend Authentication Flow

- Auth state is managed in `src/lib/stores/auth.ts` (Svelte store).
- The store uses `fetch` with `credentials: 'include'` to send/receive cookies.
- On app load, it calls `/profile` to restore session.
- Login/register forms dispatch events that the store handles.
- After login, the user is redirected to home; the header shows profile link and logout button.
- Protected routes (e.g., `/profile`) redirect to login if not authenticated.

### Key Components

- `LoginForm.svelte`, `RegisterForm.svelte` – reusable forms with validation.
- `Header.svelte` – shows different nav items based on auth state.
- Profile page (`/profile`) – displays user info and logout button.
- Auth store – handles API calls, loading/error states, and user object.

---

## Docker Compose Setup

The `docker-compose.yml` defines three services:

- `postgres`: PostgreSQL database with healthcheck.
- `rust_api`: Rust backend with volume mounts for live code reload (development) and persistent cargo cache.
- `frontend`: SvelteKit frontend with volume mounts for hot‑reload.

Networks and named volumes ensure proper communication and data persistence.

### Key Volumes

- `pg_data`: persists PostgreSQL data.
- `cargo_cache`: persists downloaded crate registry.
- `cargo_target`: persists compiled output for incremental builds.

---

## Running the Application

### Prerequisites

- Docker and Docker Compose (v2+)
- Node.js (only if running frontend locally without Docker)
- Rust (only if running backend locally without Docker)

### Quick Start with Docker Compose

1. Clone the repository.
2. Generate a `JWT_SECRET` and place it in `rust_api/.env` (or directly in `docker-compose.yml` environment section).
3. Build and start all services:

   ```bash
   docker-compose up --build
   ```

4. Access:
   - Frontend: `http://localhost:8080` (or `http://localhost:5173` depending on config)
   - Backend API: `http://localhost:8000`
   - PostgreSQL: `localhost:5432` (if needed externally)

### Running Locally (without Docker)

#### Backend

```bash
cd rust_api
cargo run
```

Requires a running PostgreSQL instance with the database created. Run migrations:

```bash
sqlx migrate run
```

#### Frontend

```bash
cd frontend
npm install
npm run dev
```

Set `VITE_API_URL` in `.env` to `http://localhost:8000`.

---

## Development Tips

- **Hot reload**: Both backend (`cargo-watch` via `Dockerfile.dev`) and frontend (Vite) support live reload when files change.
- **Caching**: The `cargo_target` volume prevents full rebuilds on every change. If you need a clean build, remove the volume: `docker-compose down -v`.
- **Logs**: Backend logs are coloured and show request traces. Set `RUST_LOG=debug` for more detail.
- **CORS**: The backend is configured to accept requests from `http://localhost:5173` (frontend dev server). Adjust as needed.

---

## Production Deployment

### Backend

- Use `Dockerfile.prod` (multistage build) for a smaller image.
- Set `RUST_LOG=info` and ensure `JWT_SECRET` is provided via environment (not hardcoded).
- Set `ACCESS_TOKEN_EXPIRATION` and `REFRESH_TOKEN_EXPIRATION` appropriately.
- Enable HTTPS and set cookies to `Secure`.
- Consider rate limiting and a reverse proxy (nginx, Caddy).

### Frontend

- Build with `npm run build` and serve static files via nginx or use `Dockerfile.prod`.
- Set `VITE_API_URL` to the production backend URL.
- Ensure cookies are sent with `credentials: 'include'` – this requires the backend to have CORS properly configured with `allow_credentials(true)` and a specific origin.

### Database

- Use a managed PostgreSQL service or ensure backups and replication are configured.
- Run migrations automatically on startup (the backend runs `sqlx::migrate!`).

---

## Security Considerations

- **Passwords**: Hashed with Argon2id – strong and memory‑hard.
- **Refresh tokens**: Stored as SHA‑256 hashes (deterministic) because they are high‑entropy random strings.
- **Cookies**: `HttpOnly`, `Secure` (in production), `SameSite=Lax` (or `Strict`). They are not accessible to JavaScript.
- **JWT**: Signed with a strong secret. Short‑lived (15 min) to limit exposure.
- **CORS**: Only the frontend origin is allowed, credentials are permitted.
- **Database**: Only hashed tokens are stored; a leak does not expose usable tokens.

---

## Troubleshooting

### Backend not logging requests

Ensure `RUST_LOG` is set to `info` or `debug`. The `TraceLayer` must be added before other layers (order matters). Check that the subscriber is correctly initialised.

### Cookies not persisting after browser restart

Cookies must have a `Max-Age` set. The backend now sets `max_age` based on token expiration values. Verify with browser dev tools.

### CORS errors in frontend

Check that the backend CORS middleware allows the frontend origin and `allow_credentials(true)`. For development, you may need to allow `http://localhost:5173`.

### Database connection issues

Ensure the `postgres` service is healthy before the backend starts (depends_on with healthcheck). Verify `DATABASE_URL` is correct.

### Frontend not receiving cookies

- The frontend must use `credentials: 'include'` in all `fetch` calls.
- The backend must set `Access-Control-Allow-Credentials: true` and a specific `Access-Control-Allow-Origin` (not `*`).

---

## License

MIT (or your preferred license). See individual project folders for details.

```
