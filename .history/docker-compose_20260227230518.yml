version: '3.8'

services:
  rust_api:
    build:
      context: ./rust_api          # path to your Rust project
      dockerfile: Dockerfile.dev
    ports:
      - "8000:8000"                 # map host port 8080 to container
    restart: unless-stopped
    environment:
      # Database connection – using the same variables as go_api
      DATABASE_URL: postgres://auth_user:auth_pass@postgres:5432/auth_db
      # Session secret – generate a strong random string
      SESSION_SECRET: 4d55c25b447abe6bfe2f4507bbaa1ac6427676d350ab72663d4224478c181887
      HOST: 0.0.0.0
      PORT: 8080
      # Optional: if your app reads DB_* variables separately
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: auth_user
      DB_PASSWORD: auth_pass
      DB_NAME: auth_db
    dns:
      - 8.8.8.8 
    volumes:
      - ./rust_api:/app          # Mount source code for hot-reload
      - cargo_cache:/usr/local/cargo/registry  # Persist cargo registry
    depends_on:
      postgres:
        condition: service_healthy   # wait for postgres to be ready
    networks:
      - app-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # dockerfile: Dockerfile.prod
      args:
        VITE_WS_URL: ws://go_api:8000/ws 
    ports:
      # - "5173:5173"              # Public facing
      - "8080:80"              # Public facing
    volumes:
    - ./frontend:/app          # Mount source code
    - /app/node_modules         # Prevent overwriting node_modules
    # depends_on:
    #   - go_api
    networks:
      - app-network
    restart: unless-stopped

  postgres:
    image: postgres:18-alpine
    container_name: auth_db
    environment:
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pass
      POSTGRES_DB: auth_db
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  pg_data:
  go_mod_cache:
  cargo_cache:

# Uncomment if you need a PostgreSQL database
#   db:
#     image: postgres:15-alpine
#     environment:
#       POSTGRES_USER: user
#       POSTGRES_PASSWORD: pass
#       POSTGRES_DB: mydb
#     volumes:
#       - pgdata:/var/lib/postgresql/data
#     ports:
#       - "5432:5432"
#     restart: unless-stopped
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U user -d mydb"]
#       interval: 10s
#       timeout: 5s
#       retries: 5

# volumes:
#   pgdata: